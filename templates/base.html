<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="refresh" content="300">
    <title>Health Guardian</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body class="bg-light">
    <nav class="navbar navbar-expand-lg navbar-custom shadow-sm sticky-top">
        <div class="container">
            <a class="navbar-brand" href="{{ url_for('dashboard') }}"><i class="bi bi-hospital"></i> FAMILY HEALTH</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto align-items-center">
                    {% if current_user.is_authenticated %}
                        {% if active_profile %}
                        <li class="nav-item dropdown me-2">
                            <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                                <i class="bi bi-person-circle me-1"></i> Viewing: <strong>{{ active_profile.profile_name }}</strong>
                            </a>
                            <ul class="dropdown-menu dropdown-menu-end">
                                {% for profile in profiles %}
                                    <li><a class="dropdown-item {% if profile.id == active_profile.id %}active{% endif %}" href="{{ url_for('switch_profile', profile_id=profile.id) }}">{{ profile.profile_name }}</a></li>
                                {% endfor %}
                                <li><hr class="dropdown-divider"></li>
                                <li><a class="dropdown-item" href="{{ url_for('manager_dashboard') }}"><i class="bi bi-grid-fill me-2"></i>Family Overview</a></li>
                                <li><a class="dropdown-item" href="{{ url_for('profiles') }}"><i class="bi bi-gear-fill me-2"></i>Manage Profiles</a></li>
                            </ul>
                        </li>
                        {% endif %}
                        <li class="nav-item"><a class="nav-link" href="{{ url_for('dashboard') }}">Dashboard</a></li>
                        <li class="nav-item"><a class="nav-link" href="{{ url_for('stats') }}">Stats</a></li>
                        <li class="nav-item">
                            <a class="btn btn-sm btn-outline-secondary me-2" href="{{ url_for('my_account') }}">
                                <i class="bi bi-person-fill me-1"></i> My Account
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="btn btn-sm btn-primary" href="{{ url_for('logout') }}">
                                <i class="bi bi-box-arrow-right me-1"></i> Logout
                            </a>
                        </li>
                    {% else %}
                        <li class="nav-item"><a class="nav-link" href="{{ url_for('login') }}">Login</a></li>
                        <li class="nav-item"><a class="nav-link" href="{{ url_for('register') }}">Register</a></li>
                    {% endif %}
                </ul>
            </div>
        </div>
    </nav>

    <main class="container py-4">
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}
        {% block content %}{% endblock %}
    </main>
    
    {% if current_user.is_authenticated and daily_reminders %}
    <div id="reminder-data" style="display: none;">{{ daily_reminders | tojson | safe }}</div>
    <div id="taken-today-data" style="display: none;">{{ taken_today_ids | tojson | safe }}</div>
    {% endif %}
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        if ("Notification" in window && Notification.permission !== "granted" && Notification.permission !== "denied") {
            Notification.requestPermission();
        }

        const reminderDataEl = document.getElementById('reminder-data');
        const takenTodayEl = document.getElementById('taken-today-data');

        if (!reminderDataEl || !takenTodayEl) return;

        try {
            const reminders = JSON.parse(reminderDataEl.textContent || '[]');
            const takenTodaySet = new Set(JSON.parse(takenTodayEl.textContent || '[]'));
            const notifiedTimes = new Set();
            let lastCheckedTime = new Date();
            
            // --- DEBUG --- Log initial data
            console.log('Reminder script loaded. Total reminders for today:', reminders.length);

            function checkReminders() {
                const now = new Date();
                
                reminders.forEach(reminder => {
                    const [hourIST, minuteIST] = reminder.time.split(':').map(Number);
                    const reminderTimeUTC = new Date();
                    reminderTimeUTC.setUTCFullYear(now.getUTCFullYear(), now.getUTCMonth(), now.getUTCDate());
                    
                    let hourUTC = hourIST - 5;
                    let minuteUTC = minuteIST - 30;

                    if (minuteUTC < 0) {
                        minuteUTC += 60;
                        hourUTC -= 1;
                    }
                    if (hourUTC < 0) {
                        hourUTC += 24;
                    }
                    
                    reminderTimeUTC.setUTCHours(hourUTC, minuteUTC, 0, 0);

                    const uniqueId = reminder.name + reminder.time;
                    if (!notifiedTimes.has(uniqueId)) {
                        // --- DEBUG --- Log the comparison for each reminder
                        console.log(
                            `Checking: ${reminder.name} at ${reminder.time} IST.`,
                            `Current Time (UTC): ${now.toISOString()}`,
                            `Reminder Time (UTC): ${reminderTimeUTC.toISOString()}`,
                            `Should fire? ${reminderTimeUTC > lastCheckedTime && reminderTimeUTC <= now}`
                        );
                    }
                    
                    if (reminderTimeUTC > lastCheckedTime && reminderTimeUTC <= now) {
                        if (!takenTodaySet.has(reminder.id) && !notifiedTimes.has(uniqueId)) {
                            // --- DEBUG --- Log when a notification is being sent
                            console.warn(`NOTIFICATION FIRING for ${reminder.name}`);
                            showNotification(reminder.name, reminder.time);
                            notifiedTimes.add(uniqueId);
                        }
                    }
                });

                lastCheckedTime = now;
            }

            function showNotification(medicineName, medicineTimeIST) {
                if (!("Notification" in window) || Notification.permission !== "granted") return;
                const time12hr = new Date('1970-01-01T' + medicineTimeIST + 'Z').toLocaleTimeString('en-US', {timeZone:'UTC', hour: '2-digit', minute:'2-digit', hour12: true });
                const options = { body: `It's time to take your ${medicineName} (scheduled for ${time12hr}).`, icon: "https://cdn-icons-png.flaticon.com/512/3022/3022827.png" };
                new Notification("Medication Reminder", options);
            }
            
            setInterval(checkReminders, 30000);
            checkReminders();

        } catch (e) {
            console.error("Error in reminder script:", e);
        }
    });
</script>
</body>
</html>
